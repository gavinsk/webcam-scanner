<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Webcam to PDF Scanner (Manual Warp Crop)</title>
<style>
  body { font-family: sans-serif; text-align: center; margin: 20px; background: #f4f4f4; }
  video { border: 2px solid #333; border-radius: 4px; }
  button { margin: 5px; padding: 8px 12px; font-size: 14px; cursor: pointer; }
  .thumb-container { display: inline-block; text-align: center; margin: 5px; background: white; padding: 5px; border-radius: 4px; }
  .thumb-container img { display: block; height: 120px; margin-bottom: 5px; border: 1px solid #ccc; }
  #cropModal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
               background: rgba(0,0,0,0.85); justify-content: center; align-items: center; flex-direction: column; }
  #cropCanvas { background: white; cursor: crosshair; }
</style>
</head>
<body>

<h1>Webcam to PDF Scanner</h1>
<video id="video" autoplay playsinline></video><br>
<button id="captureBtn">üì∑ Capture Page</button>
<button id="downloadBtn">üíæ Download PDF</button>
<div id="thumbnails"></div>

<!-- Crop Modal -->
<div id="cropModal">
  <canvas id="cropCanvas"></canvas><br>
  <button id="applyCrop">‚úÖ Apply Crop</button>
  <button id="cancelCrop">‚ùå Cancel</button>
</div>

<!-- OpenCV.js -->
<script async src="https://docs.opencv.org/4.x/opencv.js"
        onload="cv['onRuntimeInitialized']=()=>{window.cvReady=true;}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<script>
(async function(){
  const video = document.getElementById('video');
  const captureBtn = document.getElementById('captureBtn');
  const downloadBtn = document.getElementById('downloadBtn');
  const thumbnails = document.getElementById('thumbnails');
  const capturedImages = [];

  const cropModal = document.getElementById('cropModal');
  const cropCanvas = document.getElementById('cropCanvas');
  const cropCtx = cropCanvas.getContext('2d');
  const applyCropBtn = document.getElementById('applyCrop');
  const cancelCropBtn = document.getElementById('cancelCrop');

  let croppingIndex = null;
  let points = [];
  let draggingPoint = null;

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { width: { ideal: 1920 }, height: { ideal: 1080 } }
    });
    video.srcObject = stream;
  } catch (err) {
    alert("Error accessing webcam: " + err);
    return;
  }

  function renderThumbnails(){
    thumbnails.innerHTML = "";
    capturedImages.forEach((imgObj, index) => {
      const container = document.createElement('div');
      container.className = "thumb-container";

      const img = document.createElement('img');
      img.src = imgObj.data;
      container.appendChild(img);

      // Rotate
      const rotateBtn = document.createElement('button');
      rotateBtn.textContent = "üîÑ Rotate";
      rotateBtn.onclick = () => {
        const tempCanvas = document.createElement('canvas');
        const ctx = tempCanvas.getContext('2d');
        tempCanvas.width = imgObj.height;
        tempCanvas.height = imgObj.width;
        ctx.translate(tempCanvas.width / 2, tempCanvas.height / 2);
        ctx.rotate(Math.PI / 2);
        ctx.drawImage(imgObj.imageElement, -imgObj.width / 2, -imgObj.height / 2);
        imgObj.data = tempCanvas.toDataURL('image/jpeg', 1.0);
        imgObj.width = tempCanvas.width;
        imgObj.height = tempCanvas.height;
        imgObj.imageElement = new Image();
        imgObj.imageElement.src = imgObj.data;
        imgObj.imageElement.onload = renderThumbnails;
      };
      container.appendChild(rotateBtn);

      // Crop
      const cropBtn = document.createElement('button');
      cropBtn.textContent = "‚úÇÔ∏è Crop";
      cropBtn.onclick = () => startCropping(index);
      container.appendChild(cropBtn);

      // Delete
      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = "üóë Delete";
      deleteBtn.onclick = () => {
        capturedImages.splice(index, 1);
        renderThumbnails();
      };
      container.appendChild(deleteBtn);

      thumbnails.appendChild(container);
    });
  }

  captureBtn.onclick = () => {
    const canvas = document.createElement('canvas');
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video, 0, 0);
    const imgData = canvas.toDataURL('image/jpeg', 1.0);
    const imgElement = new Image();
    imgElement.src = imgData;
    imgElement.onload = () => {
      capturedImages.push({
        data: imgData,
        width: canvas.width,
        height: canvas.height,
        imageElement: imgElement
      });
      renderThumbnails();
    };
  };

  function startCropping(index){
    if (!window.cvReady) {
      alert("OpenCV.js is still loading, please try again in a moment.");
      return;
    }
    croppingIndex = index;
    const imgObj = capturedImages[index];
    cropCanvas.width = imgObj.width;
    cropCanvas.height = imgObj.height;
    cropCtx.drawImage(imgObj.imageElement, 0, 0);

    // Initialize points 10% in from each edge
    points = [
      {x: imgObj.width * 0.1, y: imgObj.height * 0.1}, // top-left
      {x: imgObj.width * 0.9, y: imgObj.height * 0.1}, // top-right
      {x: imgObj.width * 0.9, y: imgObj.height * 0.9}, // bottom-right
      {x: imgObj.width * 0.1, y: imgObj.height * 0.9}  // bottom-left
    ];

    drawCropOverlay();
    cropModal.style.display = "flex";
  }

  function drawCropOverlay(){
    const imgObj = capturedImages[croppingIndex];
    cropCtx.drawImage(imgObj.imageElement, 0, 0);
    cropCtx.strokeStyle = "red";
    cropCtx.lineWidth = 2;
    cropCtx.beginPath();
    cropCtx.moveTo(points[0].x, points[0].y);
    for (let i = 1; i < points.length; i++) {
      cropCtx.lineTo(points[i].x, points[i].y);
    }
    cropCtx.closePath();
    cropCtx.stroke();

    cropCtx.fillStyle = "yellow";
    points.forEach(p => {
      cropCtx.beginPath();
      cropCtx.arc(p.x, p.y, 8, 0, 2 * Math.PI);
      cropCtx.fill();
      cropCtx.stroke();
    });
  }

  cropCanvas.onmousedown = (e) => {
    const rect = cropCanvas.getBoundingClientRect();
    const mx = e.clientX - rect.left;
    const my = e.clientY - rect.top;
    points.forEach((p, idx) => {
      if (Math.hypot(p.x - mx, p.y - my) < 10) draggingPoint = idx;
    });
  };

  cropCanvas.onmousemove = (e) => {
    if (draggingPoint === null) return;
    const rect = cropCanvas.getBoundingClientRect();
    points[draggingPoint].x = e.clientX - rect.left;
    points[draggingPoint].y = e.clientY - rect.top;
    drawCropOverlay();
  };

  cropCanvas.onmouseup = () => {
    draggingPoint = null;
  };

  applyCropBtn.onclick = () => {
    const imgObj = capturedImages[croppingIndex];
    const srcTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
      points[0].x, points[0].y,
      points[1].x, points[1].y,
      points[2].x, points[2].y,
      points[3].x, points[3].y
    ]);

    // US Letter portrait 850x1100 px
    const dstW = 850, dstH = 1100;
    const dstTri = cv.matFromArray(4, 1, cv.CV_32FC2, [
      0, 0,
      dstW - 1, 0,
      dstW - 1, dstH - 1,
      0, dstH - 1
    ]);

    const M = cv.getPerspectiveTransform(srcTri, dstTri);
    const srcMat = cv.imread(imgObj.imageElement);
    const dst = new cv.Mat();
    cv.warpPerspective(srcMat, dst, M, new cv.Size(dstW, dstH));

    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = dstW;
    tempCanvas.height = dstH;
    cv.imshow(tempCanvas, dst);

    imgObj.data = tempCanvas.toDataURL('image/jpeg', 1.0);
    imgObj.width = dstW;
    imgObj.height = dstH;
    imgObj.imageElement = new Image();
    imgObj.imageElement.src = imgObj.data;
    imgObj.imageElement.onload = renderThumbnails;

    srcTri.delete(); dstTri.delete(); M.delete(); srcMat.delete(); dst.delete();
    cropModal.style.display = "none";
  };

  cancelCropBtn.onclick = () => {
    cropModal.style.display = "none";
  };

  downloadBtn.onclick = () => {
    if (!capturedImages.length) {
      alert("No pages captured!");
      return;
    }
    const { jsPDF } = window.jspdf;
    const first = capturedImages[0];
    const pdf = new jsPDF({
      orientation: "portrait",
      unit: "px",
      format: [850, 1100]
    });
    capturedImages.forEach((img, index) => {
      if (index > 0) {
        pdf.addPage([850, 1100], "portrait");
      }
      pdf.addImage(img.data, 'JPEG', 0, 0, 850, 1100);
    });
    pdf.save("scan.pdf");
  };
})();
</script>

</body>
</html>
